import re
import pandas as pd
import tkinter as tk
from tkinter import scrolledtext
import textwrap
temp_score = None
temp_khoi = None
# Đọc file CSV
df = pd.read_csv("dulieutruong.csv", delimiter=";", encoding="utf-8")
danh_sach_truong = sorted(df["Trường"].dropna().unique())
tat_ca_khoi = ["A00", "A01", "C00", "D01", "B00"]
nganh_hoc = [
            "Y khoa", 
            "Công nghệ thông tin", 
            "Kinh tế",   
            "Sư phạm",
            "Ngôn ngữ",
            "Kỹ thuật Cơ điện tử",
            "Kế toán",
            "Kiểm toán",
            "Luật",
            "Marketing",
            "Logistics",
            "Kỹ thuật cơ khí",
            "Kỹ thuật ô tô",
            "Xây dựng",
            "Thương mại điện tử",
            "Quản trị kinh doanh"
]
rename_map = {
    "Trường": "Trường",
    "Ngành": "Ngành",
    "Chuyên ngành": "Chuyên ngành",
    "Điểm chuẩn": "Điểm",
    "Khối thi": "Khối"
}


# Định nghĩa lại tên cột
df = df.rename(columns={c.strip(): rename_map.get(c.strip(), c.strip()) for c in df.columns})
if "Điểm" in df.columns:
    df["Điểm"] = df["Điểm"].astype(str).str.replace(",", ".").astype(float)
# Xử lý cột khối nếu có cột thì tách chuỗi thành mảng các khối
if "Khối" in df.columns:
    df["Khối"] = df["Khối"].fillna("").apply(
        lambda x: [k.strip().upper() for k in str(x).split(",") if k.strip()] 
        if pd.notna(x) and str(x).strip() != "" 
        else []
    )
else:
    # Nếu không có cột Khối thì tạo cột rỗng
    df["Khối"] = [[] for _ in range(len(df))]


# Định dạng lại text
def normalize_text(s):
    return str(s).lower().strip()

# Xử lý input người dùng
def parse_input(user_input):
    diem = re.findall(r"\d+[.,]?\d*", user_input)
    diem = float(diem[0].replace(",", ".")) if diem else None
    user_norm = normalize_text(user_input)

    nganh_synonyms = {
        "y": "Y khoa",
        "y khoa": "Y khoa",
        "cntt": "Công nghệ thông tin",
        "công nghệ thông tin": "Công nghệ thông tin",
        "kt": "Kinh tế",
        "kinh tế": "Kinh tế",
        "sư phạm": "Sư phạm",
        "ngôn ngữ": "Ngôn ngữ",
        "cơ điện tử": "Kỹ thuật Cơ điện tử",
        "kế toán": "Kế toán",
        "kiểm toán": "Kiểm toán",
        "luật": "Luật",
        "marketing": "Marketing",
        "logistics": "Logistics",
        "cơ khí": "Kỹ thuật cơ khí",
        "ô tô": "Kỹ thuật ô tô",
        "xây dựng": "Xây dựng",
        "thương mại điện tử": "Thương mại điện tử",
        "quản trị kinh doanh": "Quản trị kinh doanh",
        "qtkd" :"Quản trị kinh doanh"
    }
    nganh = None
    for key, val in nganh_synonyms.items():
        if key in user_norm:
            nganh = val
            break

    chuyennganh = None
    for val in df["Chuyên ngành"].dropna().unique():
        if normalize_text(val) in user_norm:
            chuyennganh = val
            break

    khoithi = None 
    
    for khoi in tat_ca_khoi:
        if khoi.lower() in user_norm:
            khoithi = khoi
            break

    return diem, nganh, chuyennganh, khoithi

# Gợi ý trường dựa trên input
def suggest_school(diem, nganh, chuyennganh, khoithi):
    results = df.copy()

    if not any([diem, nganh, chuyennganh, khoithi]):
        return "Bạn chưa nhập thông tin gì. Hãy chọn một trong các tùy chọn bên trên!"

    if nganh:
        results = results[results["Ngành"].apply(normalize_text) == normalize_text(nganh)]
        
    if chuyennganh:
        results = results[results["Chuyên ngành"].apply(normalize_text) == normalize_text(chuyennganh)]
    
    if diem:
        results = results[results["Điểm"] <= diem]
    
    if khoithi:  
        results = results[results["Khối"].apply(lambda arr: khoithi in arr)]

    if results.empty:
        return "Không tìm thấy trường phù hợp với yêu cầu của bạn."

    results = results.sort_values(by="Điểm", ascending=False)

    ans = "Các trường phù hợp:\n"
    for _, row in results.iterrows():
        ans += f"- {row['Trường']} ({row['Ngành']}-{row['Chuyên ngành']}, {row['Điểm']} điểm, {row['Khối']})\n"
    return ans

def chatbot_response(user_msg):
    diem, nganh, chuyennganh, khoithi = parse_input(user_msg)
    return suggest_school(diem, nganh, chuyennganh, khoithi)


# Giao diện Tkinter
def start_move(event):
    root._drag_data = {"x": event.x, "y": event.y}
def stop_move(event):
    root._drag_data = None
def do_move(event):
    if root._drag_data:
        deltax = event.x - root._drag_data["x"]
        deltay = event.y - root._drag_data["y"]
        x = root.winfo_x() + deltax
        y = root.winfo_y() + deltay
        root.geometry(f"+{x}+{y}")
def close_app():
    root.destroy()


root = tk.Tk()
root.overrideredirect(True) 
root.config(bg="#1E1E1E")
root._drag_data = None 

title_bar = tk.Frame(root, bg="#3A3B3C", height=35)
title_bar.pack(fill="x")
title_bar.pack_propagate(False) 

title_label = tk.Label(title_bar, text="Chatbot Tư Vấn Chọn Trường", bg="#3A3B3C", fg="#E4E6EB", font=("Arial", 10, "bold"))
title_label.pack(side="left", padx=15)

close_btn = tk.Button(title_bar, text="✕", bg="#3A3B3C", fg="white", bd=0, 
                      activebackground="#E81123", activeforeground="white", 
                      command=close_app, font=("Arial", 12), width=4)
close_btn.pack(side="right", fill="y")

title_bar.bind("<ButtonPress-1>", start_move)
title_bar.bind("<ButtonRelease-1>", stop_move)
title_bar.bind("<B1-Motion>", do_move)


# Màn hình chính
width, height = 610, 600
screen_width = root.winfo_screenwidth()
screen_height = root.winfo_screenheight()
x = (screen_width // 2) - (width // 2)
y = (screen_height // 2) - (height // 2)
root.geometry(f"{width}x{height}+{x}+{y}")

chat_container = tk.Frame(root, bg="#242526")
chat_container.pack(fill="both", expand=True, padx=5, pady=5)
canvas = tk.Canvas(chat_container, bg="#242526", highlightthickness=0)
scrollbar = tk.Scrollbar(chat_container, orient="vertical", command=canvas.yview)
scrollable_frame = tk.Frame(canvas, bg="#242526")
scrollable_frame.bind("<Configure>", lambda e: canvas.configure(scrollregion=canvas.bbox("all")))

# Cập nhật vùng cuộn khi canvas thay đổi kích thước
def configure_scroll_region(event):
    canvas.configure(scrollregion=canvas.bbox("all"))
    canvas.itemconfig(canvas_frame_id, width=event.width)

# Thiết lập canvas và scrollbar
canvas = tk.Canvas(chat_container, bg="#242526", highlightthickness=0)
scrollbar = tk.Scrollbar(chat_container, orient="vertical", command=canvas.yview)
scrollable_frame = tk.Frame(canvas, bg="#242526")
canvas_frame_id = canvas.create_window((0, 0), window=scrollable_frame, anchor="nw")

canvas.configure(yscrollcommand=scrollbar.set)
canvas.pack(side="left", fill="both", expand=True)
scrollbar.pack(side="right", fill="y")
scrollable_frame.bind("<Configure>", lambda e: canvas.configure(scrollregion=canvas.bbox("all")))
canvas.bind("<Configure>", configure_scroll_region)

# Cuộn xuống cuối
def scroll_to_bottom():
    canvas.configure(scrollregion=canvas.bbox("all"))
    canvas.update_idletasks()
    canvas.yview_moveto(1.0)

# Chức năng nút nhập ngành
def action_nhap_nganh():
    create_bubble(
        scrollable_frame,
        f"Chatbot: Bạn muốn xét tuyển vào ngành nào? (Các ngành có trong hệ thống: {', '.join(nganh_hoc)})",
        "#3A3B3C",
        "#E4E6EB",
        "left"
    )
    entry.bind("<Return>", search_nganh)

def search_nganh(event=None):
    user_text = entry.get().strip()
    entry.delete(0, tk.END)

    create_bubble(scrollable_frame, user_text, "#005CFF", "white", "right")
    nganh = user_text.lower()
    result = df[df["Ngành"].str.lower().str.contains(nganh, na=False)]

    if result.empty:
        bot_reply = "Không tìm thấy trường nào với ngành bạn nhập."
    else:
        bot_reply = "Các trường phù hợp:\n\n"
        for _, row in result.iterrows():
            bot_reply += f"• {row['Trường']} ({row['Ngành']}, {row['Chuyên ngành']}, {row['Điểm']} điểm, {row['Khối']})\n"

    create_bubble(scrollable_frame, "Chatbot: " + bot_reply, "#3A3B3C", "#E4E6EB", "left")
    entry.bind("<Return>", send_message)
    canvas.update_idletasks()
    canvas.yview_moveto(1.0)

# Chức năng nút nhập điểm số
def action_nhap_diem_so():
    create_bubble(
        scrollable_frame,
        "Chatbot: Bạn được bao nhiêu điểm?",
        "#3A3B3C",
        "#E4E6EB",
        "left"
    )
    
    entry.bind("<Return>", step2_nhap_diem)

# Nhập điểm số
def step2_nhap_diem(event=None):
    global temp_score, temp_khoi

    user_text = entry.get().strip()
    entry.delete(0, tk.END)

    create_bubble(scrollable_frame, user_text, "#005CFF", "white", "right")
    match = re.search(r"(-?\d+[.,]?\d*)", user_text)
    if match:
        temp_score = float(match.group(1).replace(",", "."))
        if temp_score < 0 or temp_score > 30:
            create_bubble(
                scrollable_frame,
                "Chatbot: Điểm phải trong khoảng từ 0 đến 30! Vui lòng nhập lại.",
                "#3A3B3C", "#E4E6EB", "left"
            )
            entry.bind("<Return>", step2_nhap_diem)
            return
    else:
        create_bubble(
            scrollable_frame,
            "Chatbot: Điểm không hợp lệ! Vui lòng nhập lại.",
            "#3A3B3C", "#E4E6EB", "left"
        )
        entry.bind("<Return>", send_message)
        return
    
    create_bubble(
        scrollable_frame,
        f"Chatbot: Bạn xét tuyển theo khối nào? (Các khối có trong hệ thống: A00:Toán-Lý-Hóa, A01:Toán-Lý-Anh, C00:Văn-Sử-Địa, D01:Toán-Văn-Anh, B00:Toán-Hóa-Sinh)",
        "#3A3B3C", "#E4E6EB", "left"
    )

    entry.bind("<Return>", step3_nhap_khoi)

# Nhập khối
def step3_nhap_khoi(event=None):
    global temp_khoi, temp_score  
    
    user_text = entry.get().strip().upper()
    entry.delete(0, tk.END)
    create_bubble(scrollable_frame, user_text, "#005CFF", "white", "right")

    if user_text not in tat_ca_khoi:
        create_bubble(
            scrollable_frame,
            f"Chatbot: Khối {user_text} không tồn tại trong dữ liệu! Vui lòng nhập lại.",
            f"Vui lòng nhập 1 trong các khối sau: {', '.join(tat_ca_khoi)}",
            "#3A3B3C", "#E4E6EB", "left"
        )
        entry.bind("<Return>", step3_nhap_khoi)
        return

    temp_khoi = user_text

    create_bubble(
        scrollable_frame,
        f"Chatbot: Bạn muốn xét tuyển vào ngành nào? (Các ngành có trong hệ thống: {', '.join(nganh_hoc)})",
        "#3A3B3C", "#E4E6EB", "left"
    )

    entry.bind("<Return>", step4_nhap_nganh)

# Nhập ngành
def step4_nhap_nganh(event=None):
    global temp_khoi, temp_score
    
    nganh_user = entry.get().strip()
    entry.delete(0, tk.END)
    
    create_bubble(scrollable_frame, nganh_user, "#005CFF", "white", "right")
    nganh_norm = normalize_text(nganh_user)
    
    # Lọc theo ngành
    ket_qua_nganh = df[df["Ngành"].apply(normalize_text) == nganh_norm]
    
    if ket_qua_nganh.empty:
        create_bubble(
            scrollable_frame,
            f"Chatbot: Không tìm thấy ngành '{nganh_user}' trong cơ sở dữ liệu! Vui lòng nhập lại.",
            "#3A3B3C", "#E4E6EB", "left"
        )
        entry.bind("<Return>", step4_nhap_nganh)
        return

    # Lọc theo khối
    ket_qua_khoi = ket_qua_nganh[ket_qua_nganh["Khối"].apply(lambda arr: temp_khoi in arr)]

    if ket_qua_khoi.empty:
        create_bubble(
            scrollable_frame,
            f"Chatbot: Ngành '{nganh_user}' KHÔNG tuyển khối {temp_khoi}.",
            "#3A3B3C", "#E4E6EB", "left"
        )
        entry.bind("<Return>", step4_nhap_nganh)
        scroll_to_bottom()
        return

    # Lọc theo điểm
    ket_qua_diem = ket_qua_khoi[ket_qua_khoi["Điểm"] <= temp_score]

    if ket_qua_diem.empty:
        create_bubble(
            scrollable_frame,
            f"Chatbot: Không có trường nào tuyển ngành '{nganh_user}' (khối {temp_khoi}) với điểm {temp_score}.",
            "#3A3B3C", "#E4E6EB", "left"
        )
        entry.bind("<Return>", send_message)
        return

    # Kết quả top 5
    ket_qua_top5 = ket_qua_diem.sort_values(by="Điểm", ascending=False).head(5)

    # Hiển thị kết quả
    output_text = f"TOP 5 TRƯỜNG VÀ NGÀNH CÓ KHẢ NĂNG ĐỖ:\n\n"

    for idx, (_, row) in enumerate(ket_qua_top5.iterrows(), 1): 
        khoi_str = ', '.join(row['Khối']) if isinstance(row['Khối'], list) else str(row['Khối'])
        output_text += (
            f"{idx}. {row['Trường']}\n"
            f"   • Ngành: {row['Ngành']}\n"
            f"   • Chuyên ngành: {row['Chuyên ngành']}\n"
            f"   • Điểm: {row['Điểm']}\n"
            f"   • Khối: {khoi_str}\n\n"
        )

    create_bubble(
        scrollable_frame,
        "Chatbot: " + output_text.strip(),
        "#3A3B3C", 
        "#E4E6EB",
        "left"
    )

    entry.bind("<Return>", send_message)  

# Chức năng nút xem danh sách trường
def action_xem_danh_sach():
    danh_sach = sorted(df["Trường"].dropna().unique())

    if not danh_sach:
        msg = "Không tìm thấy trường nào trong dữ liệu."
    else:
        msg = "Danh sách tất cả các trường trong hệ thống:\n\n"
        for truong in danh_sach:
            msg += f"• {truong}\n"

    create_bubble(
        scrollable_frame,
        "Chatbot: " + msg,
        bg_color="#3A3B3C",
        fg_color="#E4E6EB",
        side="left"
    )

    canvas.update_idletasks()
    canvas.yview_moveto(1.0)

# Vẽ hình chữ nhật bo tròn
def rounded_rect(canvas, x1, y1, x2, y2, r, fill):
    points = [
        x1 + r, y1,
        x2 - r, y1,
        x2, y1,
        x2, y1 + r,
        x2, y2 - r,
        x2, y2,
        x2 - r, y2,
        x1 + r, y2,
        x1, y2,
        x1, y2 - r,
        x1, y1 + r,
        x1, y1
    ]
    return canvas.create_polygon(points, smooth=True, fill=fill, outline=fill)
    
# Tạo bong bóng tin nhắn
def create_bubble(master, text, bg_color, fg_color, side="left"):
    frame = tk.Frame(master, bg="#242526")
    frame.pack(fill="x", pady=5)
    bubble_canvas = tk.Canvas(frame, bg="#242526", highlightthickness=0, height=0)
    bubble_canvas.pack(anchor="e" if side == "right" else "w", padx=10)
    max_width = 450 
    
    text_id = bubble_canvas.create_text(
        15, 12, 
        text=text,
        fill=fg_color,
        font=("Arial", 13),
        anchor="nw",
        width=max_width,
    )

    bbox = bubble_canvas.bbox(text_id)
    x1, y1, x2, y2 = bbox[0]-12, bbox[1]-8, bbox[2]+12, bbox[3]+8
    rect_id = rounded_rect(bubble_canvas, x1, y1, x2, y2, r=20, fill=bg_color)
    bubble_canvas.tag_lower(rect_id, text_id) 
    bubble_canvas.config(width=x2 + 5, height=y2 + 5)
    root.after(10, scroll_to_bottom)

# Nút lựa chọn
def create_option_button(master, text, command=None):
    frame = tk.Frame(master, bg="#242526")
    frame.pack(fill="x", pady=3)

    btn = tk.Button(
        frame,
        text=text,
        bg="#005CFF",      
        fg="white",
        font=("Arial", 12),
        relief="flat",
        padx=15,
        pady=8,
        command=command,
        wraplength=250,    
        justify="left",
        cursor="hand2"     
    )

    btn.bind("<Enter>", lambda e: btn.config(bg="#005CFF"))
    btn.bind("<Leave>", lambda e: btn.config(bg="#005CFF"))
    btn.pack(anchor="w", padx=20) 
    return btn

# Gửi tin nhắn
def send_message(event=None):
    user_msg = entry.get().strip()
    if not user_msg:
        return

    create_bubble(scrollable_frame, user_msg, "#005CFF", "white", "right")
    bot_msg = chatbot_response(user_msg)
    create_bubble(scrollable_frame, bot_msg, "#3A3B3C", "#E4E6EB", "left")

    canvas.update_idletasks()
    canvas.yview_moveto(1.0)
    entry.delete(0, tk.END)

# Bắt đầu khởi động
create_bubble(scrollable_frame,
              "Xin chào! Tôi là chatbot tư vấn chọn trường.\nBạn muốn tôi giúp gì?",
              "#3A3B3C", "#E4E6EB", "left")

option_frame = tk.Frame(scrollable_frame, bg="#242526")
option_frame.pack(fill="x", pady=5)

create_option_button(option_frame, "Tìm trường theo ngành", action_nhap_nganh)
create_option_button(option_frame, "Tìm trường theo số điểm", action_nhap_diem_so)
create_option_button(option_frame, "Xem toàn bộ danh sách trường", action_xem_danh_sach)
##create_option_button(option_frame, "Thoát ứng dụng", close_app)

# Ô nhập tin nhắn
frame = tk.Frame(root, bg="#242526")
frame.pack(pady=(0, 10))
entry = tk.Entry(frame, width=50, font=("Arial", 13), bg="#E4E6EB", fg="black", relief="flat")
entry.pack(side="left", padx=(0, 10))
entry.bind("<Return>", send_message)

send_button = tk.Button(frame, text="Gửi", command=send_message,
                        bg="#005CFF", fg="white", font=("Arial", 14, "bold"),
                        activebackground="#0045C4", relief="flat")
send_button.pack(side="left")

root.mainloop()

